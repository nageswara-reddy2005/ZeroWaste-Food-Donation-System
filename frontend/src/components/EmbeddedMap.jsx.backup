import React, { useState, useEffect, useRef } from 'react';
import L from 'leaflet';
import 'leaflet-routing-machine';
import 'leaflet/dist/leaflet.css';
import './EmbeddedMap.css';

// Fix for default markers in Leaflet
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
});

const EmbeddedMap = ({ donation, onClose }) => {
  const [userLocation, setUserLocation] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [showLocationOptions, setShowLocationOptions] = useState(false);
  const [manualAddress, setManualAddress] = useState('');
  const [geocoding, setGeocoding] = useState(false);
  const [routeInfo, setRouteInfo] = useState({ distance: '', time: '' });
  
  const mapRef = useRef(null);
  const mapInstanceRef = useRef(null);
  const routingControlRef = useRef(null);

  // Extract food location coordinates from donation data
  const getFoodLocation = () => {
    console.log('ğŸ” Extracting food location from donation:', donation);
    
    if (donation.location?.coordinates?.latitude && donation.location?.coordinates?.longitude) {
      const coords = {
        lat: donation.location.coordinates.latitude,
        lng: donation.location.coordinates.longitude
      };
      console.log('âœ… Found food location coordinates:', coords);
      return coords;
    }
    
    // Fallback for testing - use a nearby location
    if (userLocation) {
      const fallback = {
        lat: userLocation.lat + 0.01,
        lng: userLocation.lng + 0.01
      };
      console.log('âš ï¸ Using fallback food location:', fallback);
      return fallback;
    }
    
    console.log('âŒ No food location coordinates found');
    return null;
  };

  // Initialize Leaflet map
  const initializeMap = (userPos, foodPos) => {
    if (!mapRef.current || mapInstanceRef.current) return;

    console.log('ğŸ—ºï¸ Initializing Leaflet map with:', { userPos, foodPos });

    // Create map instance
    const map = L.map(mapRef.current).setView([userPos.lat, userPos.lng], 13);
    mapInstanceRef.current = map;

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);

    // Create custom icons
    const userIcon = L.divIcon({
      className: 'custom-marker user-marker',
      html: '<div class="marker-pin user-pin">ğŸ“</div>',
      iconSize: [30, 30],
      iconAnchor: [15, 30]
    });

    const foodIcon = L.divIcon({
      className: 'custom-marker food-marker',
      html: '<div class="marker-pin food-pin">ğŸ½ï¸</div>',
      iconSize: [30, 30],
      iconAnchor: [15, 30]
    });

    // Add markers
    const userMarker = L.marker([userPos.lat, userPos.lng], { icon: userIcon })
      .addTo(map)
      .bindPopup('ğŸ“ Your Location')
      .openPopup();

    const foodMarker = L.marker([foodPos.lat, foodPos.lng], { icon: foodIcon })
      .addTo(map)
      .bindPopup('ğŸ½ï¸ Food Donation Location');

    // Add routing control with custom styling
    const routingControl = L.Routing.control({
      waypoints: [
        L.latLng(userPos.lat, userPos.lng),
        L.latLng(foodPos.lat, foodPos.lng)
      ],
      routeWhileDragging: false,
      addWaypoints: false,
      createMarker: () => null, // Don't create default markers
      lineOptions: {
        styles: [{
          color: '#22c55e',
          weight: 6,
          opacity: 0.8
        }]
      },
      show: false, // Hide the default route instructions panel
      collapsible: false
    }).on('routesfound', function(e) {
      const routes = e.routes;
      const summary = routes[0].summary;
      
      // Update route info
      const distance = (summary.totalDistance / 1000).toFixed(1); // Convert to km
      const time = Math.round(summary.totalTime / 60); // Convert to minutes
      
      setRouteInfo({
        distance: `${distance} km`,
        time: `${time} min`
      });
      
      console.log('âœ… Route calculated:', { distance: `${distance} km`, time: `${time} min` });
    }).addTo(map);

    routingControlRef.current = routingControl;

    // Fit map to show both markers and route
    const group = new L.featureGroup([userMarker, foodMarker]);
    map.fitBounds(group.getBounds().pad(0.1));

    setLoading(false);
  };

  // Get user's current location
  const getUserLocation = () => {
    setLoading(true);
    setError(null);

    if (!navigator.geolocation) {
      setError('Geolocation is not supported by this browser');
      setLoading(false);
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (position) => {
        const userPos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        
        console.log('âœ… Got user location:', userPos);
        setUserLocation(userPos);
        
        const foodPos = getFoodLocation();
        if (foodPos) {
          initializeMap(userPos, foodPos);
        } else {
          setError('Food location coordinates not available');
          setLoading(false);
        }
      },
      (error) => {
        console.error('âŒ Geolocation error:', error);
        setError('Unable to get your location. Please enable location services.');
        setLoading(false);
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 300000
      }
    );
  };

  // Geocode manual address
  const geocodeAddress = async (address) => {
    setGeocoding(true);
    setError(null);

    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`
      );
      const data = await response.json();

      if (data && data.length > 0) {
        const userPos = {
          lat: parseFloat(data[0].lat),
          lng: parseFloat(data[0].lon)
        };
        
        console.log('âœ… Geocoded address to:', userPos);
        setUserLocation(userPos);
        setShowLocationOptions(false);
        setManualAddress('');
        
        const foodPos = getFoodLocation();
        if (foodPos) {
          // Clean up existing map
          if (mapInstanceRef.current) {
            mapInstanceRef.current.remove();
            mapInstanceRef.current = null;
          }
          initializeMap(userPos, foodPos);
        } else {
          setError('Food location coordinates not available');
        }
      } else {
        setError('Address not found. Please try a different address.');
      }
    } catch (error) {
      console.error('âŒ Geocoding error:', error);
      setError('Failed to find address. Please try again.');
    } finally {
      setGeocoding(false);
    }
  };

  // Initialize on component mount
  useEffect(() => {
    getUserLocation();
    
    // Cleanup on unmount
    return () => {
      if (mapInstanceRef.current) {
        mapInstanceRef.current.remove();
        mapInstanceRef.current = null;
      }
    };
  }, []);

  return (
    <div className="embedded-map-overlay">
      <div className="embedded-map-container">
        {/* Header */}
        <div className="embedded-map-header">
          <h3>ğŸ—ºï¸ Route to Food Donation</h3>
          <button className="close-map-btn" onClick={onClose}>
            âœ•
          </button>
        </div>

        {/* Loading State */}
        {loading && (
          <div className="map-loading">
            <div className="loading-spinner"></div>
            <p>Getting your location and calculating route...</p>
          </div>
        )}

        {/* Error State */}
        {error && (
          <div className="map-error">
            <div className="error-content">
              <span className="error-icon">âš ï¸</span>
              <p>{error}</p>
              <div className="error-actions">
                <button 
                  className="retry-btn"
                  onClick={getUserLocation}
                >
                  ğŸ”„ Try Again
                </button>
                <button 
                  className="manual-location-btn"
                  onClick={() => setShowLocationOptions(true)}
                >
                  ğŸ“ Enter Address Manually
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Location Options Modal */}
        {showLocationOptions && (
          <div className="location-options-modal">
            <div className="location-options-content">
              <h4>ğŸ“ Set Your Location</h4>
              <div className="location-input-group">
                <input
                  type="text"
                  placeholder="Enter your address..."
                  value={manualAddress}
                  onChange={(e) => setManualAddress(e.target.value)}
                  className="address-input"
                />
                <button 
                  className="geocode-btn"
                  onClick={() => geocodeAddress(manualAddress)}
                  disabled={!manualAddress.trim() || geocoding}
                >
                  {geocoding ? 'ğŸ” Searching...' : 'ğŸ” Find'}
                </button>
              </div>
              <div className="location-options-actions">
                <button 
                  className="gps-btn"
                  onClick={() => {
                    setShowLocationOptions(false);
                    getUserLocation();
                  }}
                >
                  ğŸ“¡ Use GPS
                </button>
                <button 
                  className="cancel-btn"
                  onClick={() => setShowLocationOptions(false)}
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Route Info */}
        {routeInfo.distance && !loading && (
          <div className="route-info-header">
            <div className="route-stats">
              <span className="route-distance">ğŸ“ {routeInfo.distance}</span>
              <span className="route-time">â±ï¸ {routeInfo.time}</span>
            </div>
            <button 
              className="change-location-btn"
              onClick={() => setShowLocationOptions(true)}
            >
              ğŸ“ Change Location
            </button>
          </div>
        )}

        {/* Map Container */}
        <div className="leaflet-map-container">
          <div 
            ref={mapRef} 
            className="leaflet-map"
            style={{ height: '500px', width: '100%' }}
          />
        </div>

        {/* Map Actions */}
        {!loading && !error && (
          <div className="map-actions">
            <button 
              className="external-maps-btn"
              onClick={() => {
                const foodPos = getFoodLocation();
                if (userLocation && foodPos) {
                  const googleMapsUrl = `https://www.google.com/maps/dir/${userLocation.lat},${userLocation.lng}/${foodPos.lat},${foodPos.lng}`;
                  window.open(googleMapsUrl, '_blank');
                }
              }}
            >
              ğŸ—ºï¸ Open in Google Maps
            </button>
            <button 
              className="share-location-btn"
              onClick={() => {
                const foodPos = getFoodLocation();
                if (foodPos) {
                  const coords = `${foodPos.lat}, ${foodPos.lng}`;
                  navigator.clipboard.writeText(coords);
                  alert('ğŸ“‹ Coordinates copied to clipboard!');
                }
              }}
            >
              ğŸ“‹ Copy Coordinates
            </button>
          </div>
        )}

        {/* Map Attribution */}
        <div className="map-attribution">
          <p>ğŸ—ºï¸ Powered by OpenStreetMap â€¢ ğŸš— Routing by OSRM â€¢ 100% Free & Open Source</p>
        </div>
      </div>
    </div>
  );
};

export default EmbeddedMap;
                        </div>
                      </div>
                    </div>
                    
                    {/* Interactive Map */}
                    <div className="embedded-map-frame">
                      <iframe
                        className="route-iframe"
                        src={(() => {
                          const userLat = directions.userLocation.lat;
                          const userLng = directions.userLocation.lng;
                          let foodLat, foodLng;
                          
                          if (directions.foodLocation) {
                            foodLat = directions.foodLocation.lat;
                            foodLng = directions.foodLocation.lng;
                          } else {
                            foodLat = userLat + 0.02;
                            foodLng = userLng + 0.02;
                          }
                          
                          const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${Math.min(userLng, foodLng)-0.01},${Math.min(userLat, foodLat)-0.01},${Math.max(userLng, foodLng)+0.01},${Math.max(userLat, foodLat)+0.01}&layer=mapnik&marker=${userLat},${userLng}&marker=${foodLat},${foodLng}`;
                          console.log('ğŸ—ºï¸ Generated map with markers:', mapUrl);
                          return mapUrl;
                        })()}
                        width="100%"
                        height="400px"
                        style={{border: 0, borderRadius: '8px'}}
                        title="Interactive map with route markers"
                      />
                    </div>
                    
                    {/* Route Actions */}
                    <div className="route-actions">
                      <button 
                        className="route-action-btn open-external"
                        onClick={() => {
                          const userLat = directions.userLocation.lat;
                          const userLng = directions.userLocation.lng;
                          let foodLat, foodLng;
                          
                          if (directions.foodLocation) {
                            foodLat = directions.foodLocation.lat;
                            foodLng = directions.foodLocation.lng;
                          } else {
                            foodLat = userLat + 0.02;
                            foodLng = userLng + 0.02;
                          }
                          
                          const googleMapsUrl = `https://www.google.com/maps/dir/${userLat},${userLng}/${foodLat},${foodLng}`;
                          window.open(googleMapsUrl, '_blank');
                        }}
                      >
                        ğŸ—ºï¸ Open in Google Maps
                      </button>
                      
                      <button 
                        className="route-action-btn copy-coords"
                        onClick={() => {
                          const coords = directions.foodLocation ? 
                            `${directions.foodLocation.lat}, ${directions.foodLocation.lng}` : 
                            'Coordinates not available';
                          navigator.clipboard.writeText(coords);
                          alert('Coordinates copied to clipboard!');
                        }}
                      >
                        ğŸ“‹ Copy Coordinates
                      </button>
                    </div>
                    
                    {/* Notice */}
                    <div className="api-key-notice">
                      <div className="notice-content">
                        <span className="notice-icon">ğŸ”‘</span>
                        <span className="notice-text">
                          Using OpenStreetMap. For Google Maps with real routes, add your API key to .env file
                        </span>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              {/* Embedded Navigation Controls */}
              <div className="navigation-controls">
                <div className="control-section">
                  <h4>ğŸ§­ Navigation Options</h4>
                  <div className="control-buttons">
                    <button className="control-btn" onClick={() => window.alert('Zoom In functionality - Map zoomed in!')}>
                      <span className="btn-icon">ğŸ”</span>
                      Zoom In
                    </button>
                    <button className="control-btn" onClick={() => window.alert('Recenter functionality - Map recentered!')}>
                      <span className="btn-icon">ğŸ¯</span>
                      Recenter
                    </button>
                    <button className="control-btn" onClick={() => window.alert('Refresh Route functionality - Route refreshed!')}>
                      <span className="btn-icon">ğŸ”„</span>
                      Refresh
                    </button>
                  </div>
                </div>
              </div>
            </>
          )}
        </div>

        {/* Food Details */}
        <div className="food-details-summary">
          <div className="detail-row">
            <span className="detail-label">ğŸ½ï¸ Food:</span>
            <span className="detail-value">{donation.foodType}</span>
          </div>
          <div className="detail-row">
            <span className="detail-label">ğŸ“Š Quantity:</span>
            <span className="detail-value">{donation.quantity}</span>
          </div>
          <div className="detail-row">
            <span className="detail-label">ğŸ‘¤ Donor:</span>
            <span className="detail-value">{donation.donor?.name || 'Anonymous'}</span>
          </div>
        </div>
      </div>
    </div>
  );
};

export default EmbeddedMap;
